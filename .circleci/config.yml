---
version: 2.1

orbs:
  node: circleci/node@2.1
  win: circleci/windows@2.4

executors:
  linux:
    docker:
      - image: cimg/base:current
    resource_class: medium
  macos:
    macos:
      xcode: 15.4.0
    resource_class: macos.m1.medium.gen1
  windows: win/default

filters: &filters
  tags:
    only: /^\d+\.\d+\.\d+$/

# Matrices work with jobs that take parameters
jobs:

  build:
    parameters:
      os:
        type: string
      run_integration_tests:
        type: boolean
    executor: << parameters.os >>
    steps:
      # Install Rosetta if on Apple Silicon
      - when:
          condition:
            equal: ["macos", << parameters.os >>]
          steps:
            - run:
                name: Install Rosetta
                command: softwareupdate --install-rosetta --agree-to-license
      - checkout
      - node/install:
          install-npm: true
          node-version: 16.20.2
          npm-version: 8.19.4
      - run:
          name: Verify Versions
          command: |
            node --version
            npm --version
      - run:
          name: Install
          command: |
            npm i
            npm i --prefix=$HOME/.local -g pkg
            ls -la $HOME/.local
            ls -la $HOME/.local/bin
            echo 'export PATH=$HOME/.local/bin:$PATH' >> $BASH_ENV
      - run:
          name: Build
          command: |
            echo "Path: $PATH"
            echo "pkg location: $(which pkg)"
            npm run build
            tar -czvf dist/removebg_cli_VERSION_<< parameters.os >>.tar.gz dist/removebg
      - store_artifacts:
          path: dist
      - persist_to_workspace:
          root: .
          paths:
            - dist/*
            - test/*

  build-windows:
    executor: windows
    steps:
      - checkout
      - run: nvm install 16.20.2
      - run: nvm use 16.20.2
      - run:
          name: Verify Versions
          command: |
            node --version
            npm --version
      - run:
          name: Install
          command: |
            npm install
            dir
            npm i -g pkg
      - run:
          name: Build
          command: |
            npm run build
            Compress-Archive -LiteralPath dist\removebg.exe -DestinationPath dist\removebg_cli_VERSION_windows.zip
      - store_artifacts:
          path: dist
      - persist_to_workspace:
          root: .
          paths:
            - dist/*
            - test/*

workflows:
  ci:
    jobs:
      - build:
          matrix:
            parameters:
              os: [linux, macos]
          name: build-on-<< matrix.os >>
          run_integration_tests: true
          filters: *filters
      - build-windows:
          filters: *filters
